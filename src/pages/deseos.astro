---
import Layout from '../layouts/Layout.astro';
import { Image } from 'astro:assets';
// Puedes usar la misma imagen de flores u otra para un detalle en el header
import fondoFlores from '@assets/fondos-para-invitaciones-de-bodas-con-flroes-2.png'; 
import { MdOutlineArrowBack } from "react-icons/md";
---

<Layout title="Libro de Deseos - Jonathan y Areli">
    <main class="bg-boda-blanco-base min-h-screen pb-20">
        
        <header class="relative w-full min-h-[200px] md:h-48 overflow-hidden shadow-md text-boda-oscuro-base mb-16">
            <div class="absolute inset-0 z-0 bg-boda-azul-base">
                <Image src={fondoFlores} alt="Decoración" class="w-full h-full object-cover opacity-20 mix-blend-overlay" />
            </div>

            <div class="relative z-10 w-full h-full max-w-5xl mx-auto px-6 py-8 flex md:flex-row items-center justify-between gap-4">
                
                <a href="/" class="group flex items-center gap-2 hover:text-boda-rojo-base transition-colors duration-300 self-start md:self-auto">
                    <div class="p-2 rounded-full border border-boda-oscuro-base bg-white group-hover:bg-boda-blanco-base group-hover:border-boda-blanco-base transition-all">
                        <MdOutlineArrowBack size={24} />
                    </div>
                </a>

                <h1 class="text-3xl md:text-4xl font-secondary-300 tracking-widest uppercase text-center md:text-right mt-2 md:mt-0">
                    Buenos Deseos
                </h1>
            </div>
        </header>

        <div class="max-w-4xl mx-auto px-6 mt-20 relative z-20">
            
            <section class="bg-white rounded-lg shadow-2xl shadow-boda-oscuro-base py-8 md:p-14 mb-16 animate-fade-in-up flex flex-col justify-between">
                <div class="text-center mb-12">
                    <h2 class="text-xl md:text-3xl font-secondary-300 text-boda-verde-base mb-4">Déjanos un mensaje</h2>
                    <p class="text-base text-gray-500 font-secondary-100">Tus palabras quedarán guardadas en nuestro corazón.</p>
                </div>

                <form id="form-deseos" class="space-y-8">
                    
                    <div class="flex flex-col gap-3 px-8 text-left mb-4">
                        <label for="nombre" class="text-xs font-secondary-200 uppercase tracking-widest text-boda-azul-base font-bold">Tu Nombre</label>
                        <input 
                            type="text" 
                            id="nombre" 
                            name="nombre" 
                            placeholder="Ej. Tía María" 
                            required
                            class="w-full border-b-2 border-gray-200 bg-transparent py-3 px-2 text-lg text-boda-oscuro-base focus:border-boda-rojo-base focus:outline-none transition-colors font-secondary-200 placeholder:opacity-40"
                        />
                    </div>

                    <div class="flex flex-col justify-center px-8 gap-3 text-left">
                        <label for="mensaje" class="text-xs font-secondary-200 uppercase tracking-widest text-boda-azul-base font-bold">Tu Deseo</label>
                        <textarea 
                            id="mensaje" 
                            name="mensaje" 
                            rows="4" 
                            placeholder="Les deseo toda la felicidad del mundo..." 
                            required
                            class="w-full border-2 border-gray-100 rounded-lg bg-gray-50 p-5 text-base text-boda-oscuro-base focus:border-boda-rojo-base focus:bg-white focus:outline-none transition-all font-secondary-200 placeholder:opacity-40 resize-none"
                        ></textarea>
                    </div>

                    <div class="flex justify-center items-center">
                        <button 
                            type="submit" 
                            id="btn-enviar"
                            class="bg-boda-azul-base text-boda-blanco-base font-secondary-300 uppercase text-sm rounded-full hover:bg-boda-rojo-base hover:shadow-xl hover:-translate-y-1 transition-all duration-300 disabled:opacity-50 cursor-pointer hover:scale-105 transition-all"
                        >
                            <span class="px-6 py-3 block" >Enviar Deseo</span>
                        </button>
                    </div>
                </form>
            </section>

            <section>
                <div class="flex items-center justify-center gap-4 mb-12">
                    <div class="h-px w-16 bg-boda-verde-base/40"></div>
                    <h3 class="text-3xl font-secondary-300 text-boda-verde-base text-center">Muro de Amor</h3>
                    <div class="h-px w-16 bg-boda-verde-base/40"></div>
                </div>

                <div id="loader-inicial" class="flex justify-center py-10">
                    <div class="animate-pulse flex flex-col items-center">
                        <div class="h-4 w-4 bg-boda-rojo-base rounded-full mb-2 animate-bounce"></div>
                        <span class="text-xs font-secondary-100 text-gray-400">Cargando deseos...</span>
                    </div>
                </div>
                
                <div id="contenedor-deseos" class="grid grid-cols-1 md:grid-cols-2 opacity-0 transition-opacity duration-500 gap-4">
                    <!-- Los deseos se cargarán aquí dinámicamente -->
                </div>

                <p id="mensaje-vacio" class="hidden text-center text-gray-400 font-secondary-100 italic mt-8">
                    Aún no hay mensajes. ¡Sé el primero en escribir uno!
                </p>
            </section>

        </div>
    </main>
</Layout>

<script is:inline>
    // --- LÓGICA DEL FRONTEND ---

    const form = document.getElementById('form-deseos');
    const contenedor = document.getElementById('contenedor-deseos');
    const btnEnviar = document.getElementById('btn-enviar');
    const loaderInicial = document.getElementById('loader-inicial');
    const mensajeVacio = document.getElementById('mensaje-vacio');
    
    // ** URL para ENVIAR nuevos deseos (POST) **
    const POST_WEBHOOK_URL = "https://n8n-produccion.agencia1711.lat/webhook/mi-boda-alex";
    
    // ** URL para OBTENER deseos existentes (GET) **
    // ¡REEMPLAZA esta URL con tu webhook GET de n8n real!
    const GET_WEBHOOK_URL = "https://n8n-produccion.agencia1711.lat/webhook/mostrar-deseos"; 
    
    // Eliminamos datosSimulados ya que ahora usaremos la API

    const crearTarjeta = (data) => {
        // CORRECCIÓN: Leemos 'Nombre' o 'nombre' por si acaso
        const nombreReal = data.Nombre || data.nombre || "Anónimo";
        const mensajeReal = data.Mensaje || data.mensaje || "";
        const fechaReal = data.Fecha || data.fecha || "";
        console.log(data);
        

        // Aseguramos que la fecha se muestre si existe
        const fechaDisplay = fechaReal ? `<span class="text-xs text-gray-400 font-secondary-100">${fechaReal}</span>` : '';

        return `
            <article class="bg-white p-8 rounded-lg shadow-sm border border-gray-100 hover:shadow-lg transition-all duration-300 relative overflow-hidden group my-6 transform hover:-translate-y-1">
                <div class="absolute top-0 left-0 w-1.5 h-full bg-boda-azul-base transform scale-y-0 group-hover:scale-y-100 transition-transform duration-300 origin-bottom"></div>
                
                <div class="flex items-start justify-between mb-4">
                    <h4 class="font-secondary-300 text-xl text-boda-rojo-base">${nombreReal}</h4>
                </div>
                
                <p class="text-boda-oscuro-base font-secondary-200 text-base leading-relaxed opacity-80 italic relative z-10">
                    "${mensajeReal}"
                </p>
                
                <div class="mt-6 flex justify-end opacity-20 group-hover:opacity-100 transition-opacity duration-300">
                     ${fechaDisplay}
                </div>
            </article>
        `;
    };

    /**
     * Función que consume el endpoint GET para obtener y mostrar los deseos.
     */
    const cargarDeseos = async () => {
        
        loaderInicial.style.display = 'flex'; 
        contenedor.innerHTML = '';
        mensajeVacio.classList.add('hidden');

        try {
            const response = await fetch(GET_WEBHOOK_URL, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) {
                throw new Error(`Error: ${response.status}`);
            }

            const respuestaJson = await response.json(); 
            console.log("Datos recibidos:", respuestaJson);

            // --- AQUÍ ESTÁ EL TRUCO (NORMALIZACIÓN) ---
            let listaDeseos = [];

            if (Array.isArray(respuestaJson)) {
                // Caso A: n8n devolvió una lista [...]
                listaDeseos = respuestaJson;
            } else if (respuestaJson && typeof respuestaJson === 'object') {
                // Caso B: n8n devolvió un solo objeto {...}, lo envolvemos en corchetes
                listaDeseos = [respuestaJson];
            }
            // -------------------------------------------

            // ** 2. PROCESAR Y MOSTRAR **
            if (listaDeseos.length > 0) {
                // Invertimos para ver el más reciente primero
                const deseosOrdenados = listaDeseos.reverse(); 
                contenedor.innerHTML = deseosOrdenados.map(d => crearTarjeta(d)).join('');
            } else {
                console.log("La lista está vacía");
                mensajeVacio.classList.remove('hidden');
            }

        } catch (error) {
            console.error("Fallo la carga:", error);
            contenedor.innerHTML = `<p class="text-center text-boda-rojo-base italic mt-8">
                No se pudieron cargar los mensajes.
            </p>`;
        } finally {
            loaderInicial.style.display = 'none';
            contenedor.classList.remove('opacity-0');
        }
    };

    // ** LLAMAR A LA FUNCIÓN DE CARGA AL INICIAR LA PÁGINA **
    cargarDeseos();
    
    // Función para manejar el estado de carga y el icono
    const toggleLoading = (isLoading) => {
        btnEnviar.disabled = isLoading;
        const span = btnEnviar.querySelector('span');
        if (isLoading) {
            span.innerHTML = 'Enviando...'; 
        } else {
            span.innerHTML = 'Enviar Deseo';
        }
    };


    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(form);
            const datosParaEnvio = {
                nombre: formData.get('nombre'),
                mensaje: formData.get('mensaje'),
                timestamp: new Date().toISOString() 
            };
            
            toggleLoading(true);

            try {
                // ** 1. ENVIAR DATOS AL WEBHOOK (POST) **
                const response = await fetch(POST_WEBHOOK_URL, { // Usamos la nueva constante POST_WEBHOOK_URL
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify(datosParaEnvio)
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                // ** 2. RECARGAR LOS DESEOS DESPUÉS DE UN ENVÍO EXITOSO **
                form.reset();
                await cargarDeseos(); // Volvemos a cargar toda la lista para incluir el nuevo deseo
                
                alert("¡Gracias por tus buenos deseos! Mensaje enviado y lista actualizada.");

            } catch (error) {
                console.error("Error al enviar el mensaje:", error);
                alert("Hubo un error al enviar tu mensaje. Por favor, inténtalo de nuevo.");
            } finally {
                toggleLoading(false);
            }
        });
    }
</script>